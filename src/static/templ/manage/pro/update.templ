{% extends '../manage.templ' %}
{% block head %}
<style>
    div#upload>div.prog{margin-top:8px}
    div.blk-prog{border:#bdc0ba 1px dashed;padding:4px 4px}div.blk-prog>div.bar{width:0;height:4px;background-color:#5dac81;transition:width 500ms}
</style>

<script type="text/javascript" id="contjs" async>
	var editor;	
    function init() {
        var scriptTag = document.createElement('script');
        scriptTag.src = `https://cdnjs.cloudflare.com/ajax/libs/ace/1.15.0/ace.js`;
        document.head.appendChild(scriptTag);

		var j_form = $('#form');
		var j_form2 = $('#form2');
		var j_upload = $('div#upload');

		j_form.find('button.unlock').on('click', function(e) {
		    pwd = prompt('unlock password');
		    $.post('/oj/be/manage/pro/update', {
				'reqtype': 'pro-unlock',
				'pro_id': {{ pro['pro_id'] }},
				'pwd': pwd,
		    }, function(res) {
				if (res[0] == 'E') {
				    j_form.find('div.print').print(res);
				} else {
				    index.go('/oj/manage/pro/');
				}
		    });
		});

		j_form.find('button.lock').on('click', function(e) {
		    $.post('/oj/be/manage/pro', {
				'reqtype': 'pro-lock',
				'pro_id': {{ pro['pro_id'] }},
		    }, function(res) {
				if (res[0] == 'E') {
 	 	            j_form.find('div.print').print(res);
				} else {
					index.go('/oj/manage/pro/');
				}
		    });
		});

		j_form.find('button.submit').on('click', function(e) {
		    var name = j_form.find('input.name').val();
		    var tags = j_form.find('input.tags').val();
		    var status = j_form.find('select.status').val();
 	       	var clas = j_form.find('select.class').val();
 	       	var pack_type = j_form.find('select.packtype').val();
		    var files = j_form.find('input.file')[0].files;
		    var pack_token = '';

		    function _update() {
				$.post('/oj/be/manage/pro/update', {
				    'reqtype': 'updatepro',
				    'pro_id': {{ pro['pro_id'] }},
				    'name': name,
				    'tags': tags,
				    'status': status,
 	 	          	'class': clas,
 	 	          	'pack_type': pack_type,
				    'pack_token': pack_token,
				}, function(res) {
 	 	          	var msg = 'Unknown';

 	 	          	if (res[0] == 'E') {
 	 	          	    if (res == 'Enamemin') {
							msg = '	Name length < min';
 	 	          	    } else if (res == 'Enamemax') {
 	 	          	         msg = 'Name length > max';
 	 	          	    } else if (res == 'Eparam') {
 	 	          	         msg = 'Paramater Error';
 	 	          	    } else if (res == 'Econf') {
 	 	          	         msg = 'Syntex error';
 	 	          	    } else {
 	 	          	        msg = res;
 	 	          	    }

 	 	          	    if (pack_token == '') {
 	 	          	        j_form.find('div.print').print(msg);
 	 	          	    } else {
 	 	          	        j_upload.find('div.print').print(msg);
 	 	          	    }
 	 	          	} else {
				       index.go('/oj/manage/pro/');
 	 	          	}
				});
		    }

		    if (files.length == 0) {
				_update();
		    } else {
				pack.get_token().done(function(token) {
 	           	var j_bar = j_upload.find('div.prog > div.bar');

			    	j_form.hide();
					j_form2.hide();
			    	j_upload.show();

 	           	pack_token = token;
			    	pack.send(pack_token,files[0]).done(function() {
						_update();
			    	}).progress(function(prog) {
						j_bar.css('width',(prog * 100) + '%');
			    	});
				});
		    }
		});

		j_form.find('button.cancel').on('click', function(e) {
		    index.go('/oj/manage/pro/');
		});

		j_form2.find('button.submit').on('click', function(e) {
		    var timelimit = j_form2.find('input.timelimit').val();
		    var memlimit = j_form2.find('input.memlimit').val();

			$.post('/oj/be/manage/pro/update', {
			    'reqtype': 'updatelimit',
			    'pro_id': {{ pro['pro_id'] }},
			    'timelimit': timelimit,
			    'memlimit': memlimit,
			}, function(res) {
				var msg = 'Unknown';
				if (res[0] == 'E') {
					if (res == 'Etimelimitmin') {
						msg = 'Time limit is too short';
					} else if (res == 'Ememlimitmin') {
						msg = 'Mem limit is too small';
					} else {
						msg = res;
					}
					j_form2.find('div.print').print(msg);
				} else {
					index.go('/oj/manage/pro/');
				}
			});
		});

		$('#editor_button').on('click', function(e) {
			const conf_json = editor.getValue()
			try {
				JSON.parse(conf_json)
			} catch (e) {
				alert('Syntax Error')
				return
			}

			$.post('/oj/be/manage/pro/update', {
				'reqtype': 'updateconf',
				'conf': conf_json,
				'pro_id': {{ pro['pro_id'] }}
			}, function(res) {
				var msg = 'Unknown';
				if (res[0] == 'E') {
					if (res == 'Econf') {
						msg = 'Syntax Error';
					} else {
						msg = res;
					}
					j_form2.find('div.print').print(msg);
				} else {
					index.go('/oj/manage/pro/');
				}
			})
		})

		setTimeout(() => {
			editor = ace.edit('editor')
			editor.setTheme('ace/theme/monokai')
			editor.session.setMode('ace/mode/json')
		}, 50);
    }
</script>
{% end %}
{% block content %}
<div class="col-lg-10 ms-lg-2 mt-lg-2">
    <form id="form" class="blk-cont">
		{% if lock != None %}
			<label class="form-label" style="color:red;">Lock!!</label>
		{% end %}
		<input type="text" class="form-control name" placeholder="Problem Name" value="{{ pro['name'] }}">
		<input type="text" class="form-control tags" placeholder="Tags" value="{{ pro.get('tags', '') or '' }}">

		<select class="form-select status">
			<option value="0" {% if pro['status'] == 0 %} selected {% end %}>Online</option>
			<option value="1" {% if pro['status'] == 1 %} selected {% end %}>Hidden</option>
			<option value="2" {% if pro['status'] == 2 %} selected {% end %}>Offline</option>
		</select>
			<select class="form-select class">
			<option value="1" {% if pro['class'] == 1 %} selected {% end %}>Normal</option>
			<option value="2" {% if pro['class'] == 2 %} selected {% end %}>Contest</option>
		</select>

			<label>文件</label>
			<select class="form-select packtype">
			<option value="1">full</option>
			<option value="2">cont.html</option>
			<option value="3">cont.pdf</option>
		</select>
		<input type="file" class="form-control file">

		<button type="button" class="btn btn-primary submit">Update</button>
		<button type="button" class="btn btn-primary lock">Lock</button>
		<button type="button" class="btn btn-secondary unlock">UnLock</button>
		<button type="button" class="btn btn-secondary cancel">Cancel</button>
		<div class="print"></div>
    </form>
	<form id="form2" class="blk-cont" style="margin-top: 60px; border: 1px solid red; padding: 3px;">
		<label class="form-label" style="color: red;">Danger Zone</label>
		<label class="form-label">Time limit (ms)</label>
		<input type="number" class="form-control timelimit" value="{{ testl[0]['timelimit'] }}">
		<label class="form-label">Mem limit (Kb)</label>
		<input type="number" class="form-control memlimit" value="{{ round(testl[0]['memlimit'] / 1024) }}">
		<button type="button" class="btn btn-danger submit">Update</button>
		<div class="print"></div>
    </form>
    <div id="upload" style="display: none;">
		<strong>Uploading ...</strong>
		<div class="print"></div>
		<div class="blk-prog prog">
			<div class="bar"></div>
		</div>
    </div>
	<div id="editor">{{ problem_config_json }}</div>
	<button type="button" class="btn btn-success" id="editor_button">Update</button>
	<style>
		#editor {
			position: relative;
			bottom: 580px;
			left: 120%;
			width: 500px;
			height: 400px;
		}		

		#editor_button {
			position: relative;
			bottom: 570px;
			left: 120%;
		}
	</style>
</div>
{% end %}
